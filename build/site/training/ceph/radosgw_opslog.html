<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ceph RadosGW Opslog configuration :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/radosgw_opslog.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="48px" alt="Ceph">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/zh-cn/red_hat_ceph_storage/5" target="_blank">Ceph Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/likid0/ceph-top-gun-enablement/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">Ceph Storage Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Lab Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Ceph</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_introduction.html">Ceph Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_architecture.html">Ceph Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cluster_partitioning.html">Ceph Cluster Partitioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_hardware.html">Ceph Hardware Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_intro.html">Ceph Install Methods </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephadm_intro.html">Cephadm Orchestrator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_basic.html">Deploy Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cli_intro.html">Ceph CLI basic commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pools.html">Ceph storage pools config</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_bluestore.html">Ceph OSD Bluestore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_recovery.html">Ceph OSD Failure/Recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph-upgrades_cephadm.html">Upgrade Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_challenge.html">Challenge Ceph Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RADOS Block Device</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_intro.html">RADOS Block Device introduction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CephFS Shared FileSystem</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_intro.html">CephFS introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_advanced.html">CephFS Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephfs_challenge.html">Challenge Cephfs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ssl.html">RGW &amp; Ingress with SSL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_cloudsync.html">RGW Object Cloud Transition</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_presignedurl.html">RGW presigned URL</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="radosgw_opslog.html">RGW Opslog</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_notification.html">RGW bucket Notification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_bluestore.html">Troubleshooting Bluestore issues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-large-omap-objects.html">Troubleshooting Large Omap Objects</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Benchmarking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_example.html">Setting the Inital Baseline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph RadosGW</li>
    <li><a href="radosgw_opslog.html">RGW Opslog</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/radosgw_opslog.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Ceph RadosGW Opslog configuration</h1>
<div class="sect1">
<h2 id="_enable_opslog_in_rgw"><a class="anchor" href="#_enable_opslog_in_rgw"></a>1. Enable Opslog in RGW</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First thing we need to do is adding the following options in our ceph database
configuration</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>rgw_enable_ops_log:</strong> Enable/Disable rgw_ops_log.</p>
</li>
<li>
<p><strong>rgw_ops_log_rados:</strong> Whether the operations log should be written to
the Ceph Storage Cluster backend.
the following HTTP headers:</p>
</li>
<li>
<p><strong>rgw_ops_log_socket_path:</strong> Socket path where Ceph RadosGW <code>ops_log</code>
will be stored.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We add the options to the client.rgw ceph database configuration, and restart
the RGW instances</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ceph config set client.rgw rgw_enable_ops_log true
# ceph config set client.rgw rgw_ops_log_rados false
# ceph config set client.rgw rgw_ops_log_socket_path /var/run/ceph/opslog
# ceph config dump | grep client.rgw
    client.rgw                                   advanced  rgw_enable_ops_log                     true
    client.rgw                                   advanced  rgw_ops_log_rados                      false
    client.rgw                                   advanced  rgw_ops_log_socket_path                /var/run/ceph/opslog
# ceph orch ls | grep rgw.objectgw
rgw.objectgw               ?:8080           1/1  3m ago     2h   count:1;label:rgw
# ceph orch restart rgw.objectgw
Scheduled to restart rgw.objectgw.ceph-mon02.hxvmmy on host 'ceph-mon02'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the path we selected for the socket is inside the container
<code>/var/run/ceph/opslog</code> , on the host it translates to <code>/var/run/ceph/$CLUSTERFSID/opslog</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s create a bucket and copy a file to generate some operations for the
opslog to capture</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">#  aws --endpoint http://ceph-mon02:8080 s3 mb s3://demobucket --region default
make_bucket: demobucket
#  aws --endpoint http://ceph-mon02:8080 s3 cp /etc/hosts s3://demobucket/
upload: ../etc/hosts to s3://demobucket/hosts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connect to the node where the RGW daemon is running, in our case <code>ceph-mon02</code>,
to check our RadosGW ops log socket.</p>
</div>
<div class="paragraph">
<p>On the opslog socket we have both of the actions logged, creating the bucket <code>demobucket</code> and
uploading a file to the bucket</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dnf install nc -y
# nc -U --recv-only  /var/run/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/opslog
[{"bucket":"demobucket","time":"2023-01-11T20:20:49.452139Z","time_local":"2023-01-11T20:20:49.452139+0000","remote_addr":"172.16.7.64","user":"user1","operation":"create_bucket","uri":"PUT /demobucket HTTP/1.1","http_status":"200","error_code":"","bytes_sent":0,"bytes_received":0,"object_size":0,"total_time":2388,"user_agent":"aws-cli/2.9.13 Python/3.9.11 Linux/4.18.0-425.3.1.el8.x86_64 exe/x86_64.rhel.8 prompt/off command/s3.mb","referrer":"","trans_id":"tx00000c578315716012330-0063bf1a21-5f32-default","authentication_type":"Local","access_key_id":"S3user1","temp_url":false},
{"bucket":"demobucket","time":"2023-01-11T20:21:56.714423Z","time_local":"2023-01-11T20:21:56.714423+0000","remote_addr":"172.16.7.64","user":"user1","operation":"put_obj","uri":"PUT /demobucket/hosts HTTP/1.1","http_status":"200","error_code":"","bytes_sent":0,"bytes_received":1354,"object_size":1354,"total_time":1297,"user_agent":"aws-cli/2.9.13 Python/3.9.11 Linux/4.18.0-425.3.1.el8.x86_64 exe/x86_64.rhel.8 prompt/off command/s3.cp","referrer":"","trans_id":"tx00000529241f6b609d1b1-0063bf1a64-5f32-default","authentication_type":"Local","access_key_id":"S3user1","temp_url":false},</pre>
</div>
</div>
<div class="paragraph">
<p>Currently, RadosGW <code>ops_log</code> is stored in a socket. We would like to
send these logs to a file in our server or even to log aggregation server.</p>
</div>
<div class="paragraph">
<p>As a workaround until the feature described above is implemented, we can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a systemd unit:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># vim /etc/systemd/system/rgwopslog.service
[Unit]
Description=RGW opslog
After=network.target

[Service]
ExecStartPre=/bin/bash -c 'until ss -lnt |grep 8080; do sleep 1; done;'
ExecStart=/bin/bash -c "/usr/bin/nc -U  --recv-only /var/run/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/opslog &gt;&gt; /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log"
Restart=always

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a task to rotate the opslog:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># vim /etc/logrotate.d/opslogs
/var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log {
  su ceph ceph
  rotate 4
  daily
  dateext
  compress
  postrotate
    systemctl restart rgwopslog
  endscript
  missingok
  notifempty
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Lets test the configuration forcing a log rotation in debug mode</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># logrotate  -d -f  /etc/logrotate.d/opslogs
rotating pattern: /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log  forced from command line (4 rotations)
empty log files are not rotated, old logs are removed
switching euid to 167 and egid to 167
considering log /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log
Creating new state
  Now: 2023-01-11 17:22
  Last rotated at 2023-01-11 17:00
  log needs rotating
rotating log /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log, log-&gt;rotateCount is 4
dateext suffix '-20230111'
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
glob finding old rotated logs failed
renaming /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log to /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log-20230111
running postrotate script
running script with arg /var/log/ceph/274ba756-91d7-11ed-aa4c-2cc260754989/rgwops.log: "
    systemctl restart rgwopslog
"
compressing log with: /bin/gzip
switching euid to 0 and egid to 0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>The RadosGW `ops_log` can become quickly very big, thus if there
is a concern about the space usage in the system we recommend to rotate
the RadosGW `ops_log` based on the file size.</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Even when using STS temporary tokens assuming roles, the
`ops_log` is able to identify and log the original user starting the
transaction, not the temportal token itself.</pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Ceph">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
