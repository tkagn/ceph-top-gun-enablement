<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rados Gateway Cloud Transitions :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/radosgw_cloudsync.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="48px" alt="Ceph">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">Ceph Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Lab Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Ceph</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_introduction.html">Ceph Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_architecture.html">Ceph Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cluster_partitioning.html">Ceph Cluster Partitioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_hardware.html">Ceph Hardware Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_intro.html">Ceph Install Methods </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephadm_intro.html">Cephadm Orchestrator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_basic.html">Deploy Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cli_intro.html">Ceph CLI basic commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pools.html">Ceph storage pools config</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_bluestore.html">OSD Bluestore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_recovery.html">Ceph OSD Failure/Recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph-upgrades_cephadm.html">Upgrade Ceph with Cephadm</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RADOS Block Device</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_intro.html">RADOS Block Device introduction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CephFS Shared FileSystem</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_intro.html">CephFS introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_advanced.html">CephFS Deep Dive</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ssl.html">RGW &amp; Ingress with SSL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="radosgw_cloudsync.html">RGW Object Cloud Transition</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_presignedurl.html">RGW presigned URL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_opslog.html">RGW Opslog</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_notification.html">RGW bucket Notification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Benchmarking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_example.html">Setting the Inital Baseline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph RadosGW</li>
    <li><a href="radosgw_cloudsync.html">RGW Object Cloud Transition</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/radosgw_cloudsync.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Rados Gateway Cloud Transitions</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RadosGW has had for some time now a feature called ‘Data Tier Transition’, which provides us with the ability to create Storage Classes that represent storage tiers, for example, a ‘hot’ tier backed by fast media that is accessed frequently and a ‘cold’ tier backed by slow, magnetic media for data that barely needs to be accessed, We then rely on the S3 bucket lifecycle policies to transition the data from the hot storage class to the cold storage class after a defined policy is met.</p>
</div>
<div class="paragraph">
<p>With this new Ceph release, we take it a step further. RadosGW has a new feature that expands the previously mentioned data tier transition feature, making it easy to migrate data to a remote cloud service as part of the well know bucket lifecycle configuration. This feature aims to simplify data migration to multiple cloud providers when working with hybrid platform deployments.</p>
</div>
<div class="paragraph">
<p>Cloud transition has some caveats:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The transition is unidirectional; data cannot be transitioned back from the remote/cloud zone.</p>
</li>
<li>
<p>The currently supported cloud providers need to be AWS S3 API compatible.</p>
</li>
<li>
<p>A unique storage class of tier type cloud-s3 is used to configure the remote cloud S3 object store service to which the data needs to be transitioned.</p>
</li>
<li>
<p>Storage Classes are defined in the zone group placement targets, and unlike regular storage classes, they do not need to be backed by a data pool.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_terminology"><a class="anchor" href="#_basic_terminology"></a>2. Basic Terminology</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Zone Group</strong> – a collection of zones located mainly in the same geographic location, AKA Region.</p>
</div>
<div class="paragraph">
<p><strong>Zone</strong> – an instance that contains cloud services and is part of a zone group, AKA Zone.</p>
</div>
<div class="paragraph">
<p><strong>Placement</strong> – Logical separation of data within the same zone.</p>
</div>
<div class="paragraph">
<p><strong>Storage Class</strong> – Storage classes are used to customize the placement of object data. S3 Bucket Lifecycle rules can automate the transition of objects between storage classes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_radosgw_cloud_transition_lab"><a class="anchor" href="#_radosgw_cloud_transition_lab"></a>3. RadosGW cloud transition Lab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this Lab we are going to configure RGW cloud transition from our on-prem
ceph cluster to an AWS S3 bucket, objects will transition to the cloud once
their life cycle policy expires.</p>
</div>
<div class="sect2">
<h3 id="_ceph_on_premise_cluster_overview"><a class="anchor" href="#_ceph_on_premise_cluster_overview"></a>3.1. Ceph On-premise Cluster overview</h3>
<div class="paragraph">
<p>We are going to use one of our currently deployed clusters, that already have
RGW services running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph version
ceph version 16.2.8-85.el8cp (0bdc6db9a80af40dd496b05674a938d406a9f6f5) pacific (stable)

# ceph orch ps | grep rgw
rgw.multi.zone2.ceph-mon02.ybxsci  ceph-mon02  *:8000       running (3h)      86s ago   3h    95.1M        -  16.2.8-85.el8cp  b2c997ff1898  d7c438af18ce
rgw.multi.zone2.proxy02.xfzaef     proxy02     *:8000       running (3h)      85s ago   3h     170M        -  16.2.8-85.el8cp  b2c997ff1898  cf6b9b984af3
rgw.objectgw.ceph-mon02.vyeifa     ceph-mon02  *:8080       running (5h)      86s ago  14h    72.7M        -  16.2.8-85.el8cp  b2c997ff1898  ce2fc843936c</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to use <code>rgw.objectgw.ceph-mon02.vyeifa</code> rgw service to configure
cloud transitions, this RGW is service the <code>default</code> realm and zone.</p>
</div>
<div class="paragraph">
<p>By default when we deploy RGW on a Ceph cluster, we get a default zonegroup, zone and placement, from a ceph node with the admin keys available we are going to use the radosgw-admin command to list our zonegroup and zone, both of them with called default</p>
</div>
<div class="paragraph">
<p>List the current zonegroup placement, We have a placement with default placement id, containing the STANDARD storage class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">#  radosgw-admin zonegroup placement list
[
    {
        "key": "default-placement",
        "val": {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        }
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we’ll verify which storage classes we have in the current ‘default’ zone
configuration; we should see a STANDARD storage class created by default. This
is the default storage class, meaning all buckets and objects created are
written to it. You can see this storage class contains its dedicated ceph pools.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zone placement list --rgw-zone=default
[
    {
        "key": "default-placement",
        "val": {
            "index_pool": "default.rgw.buckets.index",
            "storage_classes": {
                "STANDARD": {
                    "data_pool": "default.rgw.buckets.data"
                }
            },
            "data_extra_pool": "default.rgw.buckets.non-ec",
            "index_type": 0
        }
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We first create an RGW user, with simplified access/secret keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin user create --uid=transitionuser --display-name=transitionuser --access-key=transitionuser --secret=transitionuser  --rgw-zone=default --rgw-zonegroup=default --rgw-realm=default
{
    "user_id": "transitionuser",
    "display_name": "transitionuser",
    "email": "",
    "suspended": 0,
    "max_buckets": 1000,
    "subusers": [],
    "keys": [
        {
            "user": "transitionuser",
            "access_key": "transitionuser",
            "secret_key": "transitionuser"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "type": "rgw",
    "mfa_ids": []
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We configure the AWS CLI with  the credentials from the previously created transitionuser, we create a bucket(default placement) called transition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --endpoint http://ceph-mon02:8080 s3 mb s3://transition  --region default
make_bucket: transition</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that our new bucket "transition" is using the default-placement placement_rule</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin bucket stats --bucket transition
{
    "bucket": "transition",
    "num_shards": 11,
    "tenant": "",
    "zonegroup": "b29b0e50-1301-4330-99fc-5cdcfc349acf",
    "placement_rule": "default-placement",
    "explicit_placement": {
        "data_pool": "",
        "data_extra_pool": "",
        "index_pool": ""
    },</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_s3_aws_bucket_as_our_target_for_transitions"><a class="anchor" href="#_s3_aws_bucket_as_our_target_for_transitions"></a>3.2. S3 AWS Bucket as our target for transitions</h3>
<div class="paragraph">
<p>Let’s start configuring the remote cloud service that will be the destination
of our transitioned objects. In this example, we will create an AWS S3
bucket called <code>rgwtransition</code>.</p>
</div>
<div class="paragraph">
<p>The idea behind using a namespace bucket is that the data that will be
transitioned from the RGW on-prem bucket to an S3 AWS bucket so the data will
also be available through AWS S3 APIs, so services from AWS will be able to
consume the Data from the AWS S3 Bucket without any issues.</p>
</div>
<div class="paragraph">
<p>Using AWS S3 credentials(access key and secret) we are going to configure our
aws cli client, and create the bucket we will configure as our transitioned
objects destination</p>
</div>
</div>
<div class="sect2">
<h3 id="_ceph_on_premise_cluster_storage_class_configuration"><a class="anchor" href="#_ceph_on_premise_cluster_storage_class_configuration"></a>3.3. Ceph On-premise Cluster Storage Class configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --profile aws mb s3://rgwtransition</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ceph_on_premise_cluster_lifecycle_policy_configuration"><a class="anchor" href="#_ceph_on_premise_cluster_lifecycle_policy_configuration"></a>3.4. Ceph On-premise Cluster Lifecycle Policy configuration</h3>
<div class="paragraph">
<p>Create a new storage class on the default placement within the default
zonegroup, we are using the special rgw <code>--tier-type=cloud-s3</code> , to configure the
storage class against our previously configured bucket in AWS s3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zonegroup placement add --rgw-realm=default --rgw-zonegroup=default --placement-id=default-placement --storage-class=AWS --tier-type=cloud-s3
[
    {
        "key": "default-placement",
        "val": {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "AWS",
                "STANDARD"
            ]
        }
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration of the cloud-s3 storage classes we called AWS can be done
using the <code>radosgw-admin zonegroup placement modify command</code>, with the
--tier-config parameter we can specify using <code>key,value</code> pairs the config of the
AWS S3 endpoint &amp; account credentials we gathered previously:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zonegroup placement modify --rgw-zonegroup default
# --placement-id default-placement --storage-class AWS
# --tier-config=endpoint=https://s3.us-east-1.amazonaws.com,access_key=AWSACCESSKEY,secret='AWSACCESSSECRET',multipart_sync_threshold=44432,multipart_min_part_size=44432,retain_head_object=true,target_path='rgwtransition'</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We are using <code>target_path='rgwtransition'</code> to set a specific bucket in the
cloudprovider that we pre-created, The target path specifies a prefix to which the source ‘bucket-name/object-name’ is appended. If not specified the target_path created is “rgwx-${zonegroup}-${storage-class}-cloud-bucket”.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_lifecycle_policy_and_object_transition_to_the_cloud"><a class="anchor" href="#_testing_our_lifecycle_policy_and_object_transition_to_the_cloud"></a>3.5. Testing our Lifecycle Policy and Object Transition to the cloud</h3>
<div class="paragraph">
<p>Now that we have the AWS Cloud-S3 storage class in place, we are going to
configure a Lifecycle policy to the bucket we created previously; the bucket’s name is
<code>transitions</code>, with this simple policy written in .json, all objects in the bucket older than 30
days will be transitioned to the cloud storage class called <code>AWS</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># cat transition.json
{
    "Rules": [
        {
            "Filter": {
                "Prefix": ""
            },
            "Status": "Enabled",
            "Transitions": [
                {
                    "Days": 30,
                    "StorageClass": "AWS"
                }
            ],
            "ID": "Transition Objects in bucket to AWS Blob after 30 days"
        }
    ]
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the AWS cli and the transitionuser profile, we will apply/put the bucket-lifecycle-configuration using the file transition.json we created in the previous step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws s3api --profile rgw  --endpoint http://ceph-mon02:8080 --region default put-bucket-lifecycle-configuration --lifecycle-configuration  file://transition.json --bucket transition

# aws s3api  --profile rgw  --endpoint https://ceph-mon02:8080 --region default get-bucket-lifecycle-configuration --bucket transition
{
    "Rules": [
        {
            "ID": "Transition Objects in bucket to S3 AWS after 30 days",
            "Prefix": "",
            "Status": "Enabled",
            "Transitions": [
                {
                    "Days": 30,
                    "StorageClass": "AWS"
                }
            ]
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also check that Ceph/RGW has registered this new LC policy using the
following radosgw-admin command, the status is UNINITIAL, as this LC has never
been processed, once processed, it will move into the COMPLETED state</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ radosgw-admin lc list
[
    {
        "bucket": ":transition:d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1",
        "started": "Thu, 01 Jan 1970 00:00:00 GMT",
        "status": "UNINITIAL"
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also check the rule applied to the bucket in detail with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ radosgw-admin lc get --bucket transition
{
    "prefix_map": {
        "": {
            "status": true,
            "dm_expiration": false,
            "expiration": 0,
            "noncur_expiration": 0,
            "mp_expiration": 0,
            "transitions": {
                "AWS": {
                    "days": 30
                }
            },
            "noncur_transitions": {}
        }
    },
    "rule_map": [
        {
            "id": "Transition Objects in bucket to AWS after 30 days",
            "rule": {
                "id": "Transition Objects in bucket to AWS after 30 days",
                "prefix": "",
                "status": "Enabled",
                "expiration": {
                    "days": "",
                    "date": ""
                },
                "noncur_expiration": {
                    "days": "",
                    "date": ""
                },
                "mp_expiration": {
                    "days": "",
                    "date": ""
                },
                "filter": {
                    "prefix": "",
                    "obj_tags": {
                        "tagset": {}
                    }
                },
                "transitions": {
                    "AWS": {
                        "days": "30",
                        "date": "",
                        "storage_class": "AWS"
                    }
                },
                "noncur_transitions": {},
                "dm_expiration": false
            }
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_lifecycle_policy_and_object_transition_to_the_cloud_2"><a class="anchor" href="#_testing_our_lifecycle_policy_and_object_transition_to_the_cloud_2"></a>3.6. Testing our Lifecycle Policy and Object Transition to the cloud</h3>
<div class="paragraph">
<p>So we can test our lifecycle policies promptly, we are going to enable the debug interval for the lifecycle process (each day in the bucket lifecycle
configuration equals 60 sec, so three days expiration is 3 minutes):</p>
</div>
<div class="paragraph">
<p>We set the configuration options to all our RGW instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph config set client.rgw.objectgw.ceph-mon02.vyeifa  rgw_lc_debug_interval 60
# ceph orch  daemon restart client.rgw.objectgw.ceph-mon02.vyeifa</code></pre>
</div>
</div>
<div class="paragraph">
<p>We know upload some objects to our on-prem transition bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ for i in 1 2 3 4 5
do
aws s3 --profile rgw --endpoint http://ceph-mon02:8080 --region default cp /etc/hosts s3://transition/transition$i
done

$ aws s3  --profile rgw  --endpoint http://ceph-mon02:8080 --region default ls s3://transition
2022-10-31 10:24:01       3847 transition1
2022-10-31 10:24:04       3847 transition2
2022-10-31 10:24:07       3847 transition3
2022-10-31 10:24:09       3847 transition4
2022-10-31 10:24:13       3847 transition5</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can double-check that the uploaded objects are stored in the default.rgw.buckets.data pool, this pool belongs to the STANDARD storage class in our default Zone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ rados ls -p default.rgw.buckets.data | grep transition

d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1_transition1
d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1_transition4
d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1_transition2
d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1_transition3
d9c4f708-5598-4c44-9d36-849552a08c4d.169377.1_transition5</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now going to force the Lifecycle process to start, it will evaluate all the bucket Lifecycle policies configured and will start the transition of data where needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$  radosgw-admin lc process</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we now run the radosgw-admin lc list we should the LifeCycle for our transition bucket in a completed state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ radosgw-admin lc list

[
    {

        "bucket": ":transition:d9c4f708-5598-4c44-9d36-849552a08c4d.170017.5",
        "started": "Mon, 31 Oct 2022 16:52:56 GMT",
        "status": "COMPLETE"
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we now list the objects available in the transition bucket on our on-premise cluster, we can see that the objects are 0 in size, this is because they have been transitioned to the cloud but the metadata/head of the object still is available because of the use of the "retain_head_object": "true" parameter when creating the cloud storage class, so we can list the objects but NOT download/copy them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ aws s3 --profile rgw  --endpoint http://ceph-mon02:8080 --region default ls s3://transition

2022-10-31 17:52:56          0 transition1
2022-10-31 17:51:59          0 transition2
2022-10-31 17:51:59          0 transition3
2022-10-31 17:51:58          0 transition4
2022-10-31 17:51:59          0 transition5</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we check the head of the object using the s3api we can see that the storage
class for this object is now AWS so this object has been transitioned into the cloud provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ aws s3api --profile rgw  --endpoint http://ceph-mon02:8080 --region default head-object --key transition1 --bucket transition

{

    "AcceptRanges": "bytes",
    "LastModified": "2022-10-31T16:52:56+00:00",
    "ContentLength": 0,
    "ETag": "\"46ecb42fd0def0e42f85922d62d06766\"",
    "ContentType": "binary/octet-stream",
    "Metadata": {},
    "StorageClass": "AWS"

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we check in AWS we can see that the objects are available in AWS S3. Due to
API limitations there is no way to preserve original object modification time
and ETag but they get stored as metadata attributes on the destination objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ aws s3api  --profile aws head-object --bucket rgwtransition --key transition/transition2
{
    "AcceptRanges": "bytes",
    "LastModified": "2022-10-31T16:51:58+00:00",
    "ContentLength": 3847,
    "ETag": "\"46ecb42fd0def0e42f85922d62d06766\"",
    "CacheControl": "private",
    "ContentType": "application/octet-stream",
    "Metadata": {
        "rgwx-source": "rgw",
        "rgwx-source-key": "transition2",
        "rgwx-source-etag": "46ecb42fd0def0e42f85922d62d06766",
        "rgwx-source-mtime": "1667234534.721441325",
        "rgwx-versioned-epoch": "0"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid object names collision across various buckets, source bucket name is prepended to the target object name. If the object is versioned, object versionid is appended to the end.</p>
</div>
<div class="paragraph">
<p>Below is the sample object name format:</p>
</div>
<div class="paragraph">
<p><code>s3://&lt;target_path&gt;/&lt;source_bucket_name&gt;/&lt;source_object_name&gt;(-&lt;source_object_version_id&gt;)</code></p>
</div>
<div class="paragraph">
<p>For versioned and locked objects, similar semantics as that of LifecycleExpiration are applied as stated below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the object is current, post transitioning to cloud, it is made noncurrent with delete marker created.</p>
</li>
<li>
<p>If the object is noncurrent and is locked, its transition is skipped.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Ceph">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
